---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import CardBlog from "@/components/CardBlog.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import getUniqueCategories from "@/utils/getUniqueCategories";
import { SITE } from "@/config";

export const getStaticPaths = (() => {
  return [{ params: { page: undefined } }];
}) satisfies GetStaticPaths;

const posts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = getSortedPosts(posts);
const categories = getUniqueCategories(posts);
---

<Layout title={`Blog | ${SITE.title}`}>
  <Header />
  <main id="main-content" class="app-layout-wide py-12">
    <h1 class="mb-2 text-3xl font-bold">Blog</h1>
    <p class="mb-8 opacity-60">함께하는 프로그래밍과 IT 이야기</p>

    {/* Category Filter Tabs */}
    <div class="mb-8 flex flex-wrap gap-2" id="category-filters">
      <button
        data-category="all"
        class="filter-btn active rounded-full border border-accent bg-accent px-4 py-1.5 text-sm font-medium text-white transition-all"
      >
        전체
      </button>
      {categories.map(category => (
        <button
          data-category={category}
          class="filter-btn rounded-full border border-border px-4 py-1.5 text-sm font-medium transition-all hover:border-accent hover:text-accent"
        >
          {category}
        </button>
      ))}
    </div>

    {/* Post Grid */}
    <div
      id="posts-grid"
      class="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3 fade-in-stagger"
    >
      {sortedPosts.map(post => (
        <div class="post-card" data-category={post.data.category || ""}>
          <CardBlog post={post} />
        </div>
      ))}
    </div>
  </main>
  <Footer />
</Layout>

<script>
  import "../../scripts/fade-in.ts";

  function setupCategoryFilter() {
    const buttons = document.querySelectorAll<HTMLButtonElement>(".filter-btn");
    const cards = document.querySelectorAll<HTMLElement>(".post-card");

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const category = btn.dataset.category;

        // Update active button style
        buttons.forEach(b => {
          b.classList.remove("active", "bg-accent", "text-white", "border-accent");
          b.classList.add("border-border");
        });
        btn.classList.add("active", "bg-accent", "text-white", "border-accent");
        btn.classList.remove("border-border");

        // Filter cards
        cards.forEach(card => {
          if (category === "all" || card.dataset.category === category) {
            card.style.display = "";
          } else {
            card.style.display = "none";
          }
        });
      });
    });
  }

  setupCategoryFilter();
  document.addEventListener("astro:after-swap", setupCategoryFilter);
</script>
